# Docker Compose for CompiloHQ Infrastructure Services
# This file defines only the infrastructure services (PostgreSQL and Redis).
# The Next.js app runs locally using: cd apps/web && pnpm dev

version: '3.9'
services:
  # PostgreSQL 17.6 - CompiloHQ Database
  postgres:
    image: postgres:17.6-alpine
    container_name: compilothq-postgres
    restart: unless-stopped

    environment:
      # Database credentials
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}

      # Adjust based on your available system resources
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${POSTGRES_EFFECTIVE_CACHE_SIZE}
      POSTGRES_WORK_MEM: ${POSTGRES_WORK_MEM}
      POSTGRES_MAINTENANCE_WORK_MEM: ${POSTGRES_MAINTENANCE_WORK_MEM}

    ports:
      - "${POSTGRES_PORT}:5432"

    volumes:
      # Persistent database storage
      - postgres_data:/var/lib/postgresql/data

      # Optional: Custom PostgreSQL configuration
      # Uncomment and create postgresql.conf if needed
      # - ./postgresql.conf:/etc/postgresql/postgresql.conf

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - compilothq-network

    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          memory: ${POSTGRES_MEMORY_LIMIT}
        reservations:
          memory: ${POSTGRES_MEMORY_RESERVATION}

  # PostgreSQL 17.6 - CompiloHQ Test Database
  # Isolated test database on port 5433 to avoid conflicts with dev database
  postgres-test:
    image: postgres:17.6-alpine
    container_name: compilothq-postgres-test
    restart: unless-stopped

    environment:
      # Test database credentials
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: compilothq_test

      # Lighter resource configuration for test database
      POSTGRES_SHARED_BUFFERS: 128MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 512MB
      POSTGRES_WORK_MEM: 8MB
      POSTGRES_MAINTENANCE_WORK_MEM: 64MB

    ports:
      - "5433:5432"

    volumes:
      # Separate persistent storage for test database
      - postgres_test_data:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d compilothq_test"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - compilothq-network

    # Resource limits for test database (lighter than dev)
    deploy:
      resources:
        limits:
          memory: 512MB
        reservations:
          memory: 256MB

  # Redis 7.4 - Session Tracking & Caching
  redis:
    image: redis:7.4-alpine
    container_name: compilothq-redis
    restart: unless-stopped

    command: >
      redis-server
      --maxmemory ${REDIS_MAXMEMORY}
      --maxmemory-policy ${REDIS_MAXMEMORY_POLICY}
      --appendonly ${REDIS_APPENDONLY}
      --appendfsync ${REDIS_APPENDFSYNC}
      --save ${REDIS_SAVE_INTERVAL}

    ports:
      - "${REDIS_PORT}:6379"

    volumes:
      # Persistent Redis data (AOF + RDB snapshots)
      - redis_data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

    networks:
      - compilothq-network

    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEMORY_LIMIT}
        reservations:
          memory: ${REDIS_MEMORY_RESERVATION}

# Named volumes for data persistence
volumes:
  postgres_data:
    driver: local
    name: compilothq-postgres-data

  postgres_test_data:
    driver: local
    name: compilothq-postgres-test-data

  redis_data:
    driver: local
    name: compilothq-redis-data

# Custom network for service isolation
networks:
  compilothq-network:
    driver: bridge
    name: compilothq-network
