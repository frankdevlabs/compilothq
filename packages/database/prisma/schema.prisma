// Prisma Schema for Compilot HQ
// This schema uses a monolithic structure with organization by comment sections

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Authentication
// ============================================================================

// User persona enum for role-based access control
enum UserPersona {
  DPO              // Data Protection Officer - highest authority for GDPR compliance
  PRIVACY_OFFICER  // Privacy Manager/Officer - day-to-day privacy operations
  BUSINESS_OWNER   // Business stakeholder/project manager - submits processing activities
  IT_ADMIN         // IT Manager/System Administrator - technical system management
  SECURITY_TEAM    // Information Security Officer - security assessments
  LEGAL_TEAM       // Legal Counsel - legal review and contract assessment
}

// Organization lifecycle status enum
enum OrganizationStatus {
  ACTIVE     // Fully operational organization with all features enabled
  TRIAL      // Organization in trial period
  SUSPENDED  // Temporarily disabled organization
  CANCELLED  // Permanently deactivated organization
}

// Invitation status enum for team invitation workflow
enum InvitationStatus {
  PENDING   // Invitation sent, awaiting acceptance
  ACCEPTED  // Invitation accepted, user joined organization
  EXPIRED   // Invitation expired (7 days)
  CANCELLED // Invitation cancelled by sender
}

// Organization model with soft delete support
model Organization {
  id        String              @id @default(cuid())
  name      String              // Organization display name
  slug      String              @unique // URL-safe identifier
  settings  Json?               // Nullable unstructured settings object
  status    OrganizationStatus  // Lifecycle tracking
  deletedAt DateTime?           // Soft delete timestamp
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  // Relations
  users       User[]
  invitations Invitation[]

  @@index([deletedAt])
}

// User model with NextAuth.js v5 compatibility
model User {
  id             String       @id @default(cuid())
  name           String       // Required, non-nullable user name
  email          String       @unique
  emailVerified  DateTime?    // NextAuth.js email verification timestamp
  image          String?      // Profile picture URL
  organizationId String       // Foreign key to Organization
  primaryPersona UserPersona  @default(BUSINESS_OWNER) // Required role with default
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organization    Organization  @relation(fields: [organizationId], references: [id])
  accounts        Account[]     // OAuth provider accounts
  sessions        Session[]     // Database sessions
  invitationsSent Invitation[]  @relation("InvitationsSent")

  @@index([organizationId, primaryPersona])
  @@index([organizationId, createdAt])
}

// NextAuth.js Account model for OAuth providers
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// NextAuth.js Session model for database-stored sessions
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// NextAuth.js VerificationToken model for email magic links
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Invitation model for organization team invitations
model Invitation {
  id             String           @id @default(cuid())
  email          String
  token          String           @unique
  organizationId String
  invitedBy      String
  invitedPersona UserPersona      @default(BUSINESS_OWNER)
  status         InvitationStatus @default(PENDING)
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter      User         @relation("InvitationsSent", fields: [invitedBy], references: [id])

  @@index([email, status])
  @@index([organizationId, status])
  @@index([token])
  @@index([expiresAt])
}

// ============================================================================
// Reference Data Models
// ============================================================================

// Enums for Reference Data

enum DataNatureType {
  SPECIAL
  NON_SPECIAL
}

enum TransferMechanismCategory {
  ADEQUACY
  SAFEGUARD
  DEROGATION
  NONE
}

// Country reference model for GDPR compliance tracking
model Country {
  id          String   @id @default(cuid())
  name        String
  isoCode     String   @unique
  isoCode3    String?  @unique
  gdprStatus  Json     // Array of: "EU", "EEA", "EFTA", "Third Country", "Adequate"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([isoCode])
}

// Data nature types for classifying personal data categories
model DataNature {
  id          String          @id @default(cuid())
  name        String
  description String
  type        DataNatureType
  gdprArticle String
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([name])
  @@index([type])
}

// Processing operations from GDPR Article 4(2)
model ProcessingAct {
  id           String   @id @default(cuid())
  name         String
  description  String
  examples     Json     // Array of example strings
  requiresDPA  Boolean  @default(false)
  triggersDPIA Boolean  @default(false)
  gdprArticle  String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([name])
}

// Transfer mechanisms for cross-border data transfers
model TransferMechanism {
  id                     String                     @id @default(cuid())
  code                   String                     @unique
  name                   String
  description            String
  typicalUseCase         String
  gdprArticle            String
  category               TransferMechanismCategory
  isDerogation           Boolean
  requiresAdequacy       Boolean
  requiresDocumentation  Boolean
  isActive               Boolean                    @default(true)
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt

  @@index([name])
  @@index([category])
}

// Recipient categories for data sharing classification
model RecipientCategory {
  id                       String   @id @default(cuid())
  code                     String   @unique
  name                     String
  examples                 Json     // Array of specific recipient type examples
  commonReasons            String
  requiresDPA              Boolean  @default(false)
  requiresImpactAssessment Boolean  @default(false)
  defaultRole              String?
  isActive                 Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@index([name])
}

// ============================================================================
// Data Processing
// ============================================================================

// Future data processing models will be added here

// ============================================================================
// Compliance
// ============================================================================

// Future compliance models will be added here
